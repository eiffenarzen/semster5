<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Objek & Warna Real-Time - TensorFlow.js</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
        /* Mengatur posisi canvas di atas video */
        #container { position: relative; }
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            /* Border 2px pada canvas deteksi */
            border: 2px solid #333; 
        }
        #webcam {
            /* Border 2px pada video, pastikan ukurannya sama */
            border: 2px solid #333; 
        }
        #status { margin-top: 10px; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <h1>Deteksi Objek & Warna Real-Time ðŸŽ¨</h1>
    
    <div id="container">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <p id="status">Memuat model COCO-SSD...</p>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusElement = document.getElementById('status');
        let model = undefined;

        // --- FUNGSI BARU: ANALISIS WARNA ---
        /**
         * Menganalisis dan mengembalikan string warna rata-rata (misalnya: 'Merah', 'Biru', 'Coklat').
         * @param {number} x, y, width, height - Bounding box area.
         * @returns {string} Nama warna rata-rata.
         */
        function getAverageColor(x, y, width, height) {
            // Gambar area video ke canvas secara sementara
            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            // Ambil data piksel di dalam bounding box
            let imageData;
            try {
                imageData = ctx.getImageData(x, y, width, height);
            } catch (e) {
                // Tangani kesalahan keamanan (CORS/tainted canvas, meskipun seharusnya tidak terjadi di sini)
                return "Warna?";
            }

            const data = imageData.data;
            let totalR = 0, totalG = 0, totalB = 0;
            const step = 10; // Mengambil sampel setiap 10 piksel untuk performa
            let count = 0;

            for (let i = 0; i < data.length; i += 4 * step) {
                totalR += data[i];
                totalG += data[i + 1];
                totalB += data[i + 2];
                count++;
            }

            const avgR = totalR / count;
            const avgG = totalG / count;
            const avgB = totalB / count;

            // Logika sederhana untuk menentukan nama warna
            if (avgR > 180 && avgG < 100 && avgB < 100) return "Merah"; // Dominan Merah
            if (avgR < 100 && avgG > 180 && avgB < 100) return "Hijau"; // Dominan Hijau
            if (avgR < 100 && avgG < 100 && avgB > 180) return "Biru"; // Dominan Biru
            
            // Abu-abu, Putih, Hitam (monokromatik)
            const luminance = 0.299 * avgR + 0.587 * avgG + 0.114 * avgB;
            if (luminance > 220) return "Putih";
            if (luminance < 50) return "Hitam";
            if (Math.abs(avgR - avgG) < 30 && Math.abs(avgR - avgB) < 30) return "Abu-abu";

            // Warna campuran
            if (avgR > 150 && avgG > 100 && avgB < 80) return "Kuning";
            if (avgR > 100 && avgG < 100 && avgB > 100) return "Ungu";
            if (avgR > 120 && avgG > 60 && avgB < 60) return "Oranye";
            
            return "Coklat/Lainnya";
        }
        // ------------------------------------

        /**
         * 1. Mulai Akses Kamera
         */
        async function setupWebcam() {
            return new Promise((resolve, reject) => {
                const navigatorAny = navigator;
                navigator.getUserMedia = navigator.getUserMedia ||
                    navigatorAny.webkitGetUserMedia || navigatorAny.mozGetUserMedia ||
                    navigatorAny.msGetUserMedia;
                
                if (navigator.getUserMedia) {
                    navigator.getUserMedia(
                        { video: true },
                        stream => {
                            video.srcObject = stream;
                            video.addEventListener('loadeddata', () => resolve(), false);
                        },
                        error => reject(error)
                    );
                } else {
                    reject(new Error("Browser tidak mendukung navigator.getUserMedia."));
                }
            });
        }

        /**
         * 2. Loop Deteksi Utama
         */
        async function detectFrame() {
            // Tunggu hingga video siap
            if (video.readyState < 2 || !model) {
                requestAnimationFrame(detectFrame);
                return;
            }
            
            // **Penting:** Gambar frame video ke canvas **sebelum** deteksi
            // Ini diperlukan agar imageData dapat diakses untuk analisis warna.
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Jalankan deteksi
            const predictions = await model.detect(video);
            
            // Gambar kotak pembatas dan analisis warna
            drawBoundingBoxes(predictions);

            // Ulangi proses pada frame berikutnya
            requestAnimationFrame(detectFrame);
        }

        /**
         * 3. Menggambar Hasil Deteksi (Kotak, Label, dan Warna)
         */
        function drawBoundingBoxes(predictions) {
            // Hapus gambar sebelumnya
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.font = '16px Arial';
            ctx.lineWidth = 2;
            
            predictions.forEach(prediction => {
                // Destructuring Bounding Box [x, y, width, height]
                const [x, y, width, height] = prediction.bbox;
                
                // Analisis warna rata-rata pada area objek
                const avgColor = getAverageColor(x, y, width, height);

                const confidence = Math.round(prediction.score * 100);
                const text = `${prediction.class} (${avgColor}, ${confidence}%)`;
                
                // **Pengaturan Warna Kotak berdasarkan Objek atau Warna**
                ctx.strokeStyle = '#FF00FF'; // Warna Magenta default
                ctx.strokeRect(x, y, width, height);
                
                // Gambar latar belakang teks
                ctx.fillStyle = '#FF00FF';
                const textWidth = ctx.measureText(text).width;
                ctx.fillRect(x, y, textWidth + 8, 20); // Kotak latar belakang
                
                // Gambar teks
                ctx.fillStyle = '#FFFFFF'; // Warna Putih
                ctx.fillText(text, x + 4, y + 15);
            });
        }

        /**
         * 4. Fungsi Utama untuk Memulai Aplikasi
         */
        async function startApp() {
            try {
                // Muat model COCO-SSD
                model = await cocoSsd.load();
                statusElement.textContent = 'Model berhasil dimuat. Meminta akses kamera...';

                // Akses dan setel video
                await setupWebcam();
                
                // Menunggu metadata video dimuat untuk mendapatkan ukuran yang tepat
                await new Promise(r => video.addEventListener('loadedmetadata', r));
                
                // Atur ukuran canvas sesuai video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.width = video.videoWidth;
                video.height = video.videoHeight;

                statusElement.textContent = 'Deteksi dan Analisis Warna dimulai...';
                
                // Mulai loop deteksi
                detectFrame();
                
            } catch (error) {
                statusElement.textContent = `ERROR: ${error.message}. Pastikan Anda menggunakan HTTPS atau localhost dan mengizinkan akses kamera.`;
                console.error(error);
            }
        }

        startApp();
    </script>

</body>
</html>
