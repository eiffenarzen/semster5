<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Objek & Warna Real-Time - TensorFlow.js</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: sans-serif; 
            background-color: #f0f0f0;
        }
        h1 { color: #333; }
        /* Mengatur posisi canvas di atas video */
        #container { 
            position: relative; 
            border: 4px solid #4CAF50; /* Border kontainer */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        #webcam {
            display: block; /* Menghilangkan spasi di bawah video */
        }
        #status { 
            margin-top: 15px; 
            font-weight: bold; 
            color: #d9534f; 
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1>Deteksi Objek & Warna Real-Time üé®</h1>
    
    <div id="container">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <p id="status">Memuat model COCO-SSD...</p>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusElement = document.getElementById('status');
        let model = undefined;

        // --- FUNGSI ANALISIS WARNA ---
        /**
         * Menganalisis dan mengembalikan string nama warna rata-rata berdasarkan nilai RGB.
         * @param {number} x, y, width, height - Bounding box area.
         * @returns {string} Nama warna rata-rata.
         */
        function getAverageColor(x, y, width, height) {
            // Kita mengambil data dari ctx yang telah digambar di detectFrame()
            
            // Perlu memastikan lebar dan tinggi tidak nol atau negatif
            if (width <= 0 || height <= 0) return "Tidak Valid";

            let imageData;
            try {
                // Ambil data piksel di dalam bounding box (pastikan area tidak keluar batas canvas)
                const safeX = Math.max(0, x);
                const safeY = Math.max(0, y);
                const safeW = Math.min(width, canvas.width - safeX);
                const safeH = Math.min(height, canvas.height - safeY);
                
                imageData = ctx.getImageData(safeX, safeY, safeW, safeH);
            } catch (e) {
                console.warn("Gagal mendapatkan data piksel:", e);
                return "Warna?";
            }

            const data = imageData.data;
            let totalR = 0, totalG = 0, totalB = 0;
            const step = 10; // Sampling untuk performa
            let count = 0;

            for (let i = 0; i < data.length; i += 4 * step) {
                totalR += data[i];
                totalG += data[i + 1];
                totalB += data[i + 2];
                count++;
            }

            if (count === 0) return "Kosong";

            const avgR = totalR / count;
            const avgG = totalG / count;
            const avgB = totalB / count;

            // Klasifikasi warna sederhana
            if (avgR > 180 && avgG < 100 && avgB < 100) return "Merah"; 
            if (avgR < 100 && avgG > 180 && avgB < 100) return "Hijau"; 
            if (avgR < 100 && avgG < 100 && avgB > 180) return "Biru"; 
            
            // Monokromatik (Abu-abu, Putih, Hitam)
            const luminance = 0.299 * avgR + 0.587 * avgG + 0.114 * avgB;
            if (luminance > 230) return "Putih";
            if (luminance < 30) return "Hitam";
            if (Math.abs(avgR - avgG) < 30 && Math.abs(avgR - avgB) < 30) return "Abu-abu";

            // Warna campuran
            if (avgR > 180 && avgG > 150 && avgB < 100) return "Kuning";
            if (avgR > 150 && avgG < 100 && avgB > 150) return "Ungu";
            if (avgR > 150 && avgG > 80 && avgB < 80) return "Oranye";
            
            return "Coklat/Lainnya";
        }
        // ------------------------------------

        /**
         * 1. Mulai Akses Kamera (Menggunakan API Modern: mediaDevices)
         */
        async function setupWebcam() {
            try {
                // Gunakan navigator.mediaDevices.getUserMedia yang lebih modern
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true 
                });
                video.srcObject = stream;
                
                // Menunggu video siap dimainkan
                await new Promise(r => video.addEventListener('loadeddata', r, { once: true }));
                
                return stream;
            } catch (error) {
                console.error("Gagal mendapatkan akses kamera:", error);
                throw new Error("Gagal mendapatkan akses kamera. Pastikan Anda menjalankan melalui server lokal (localhost/HTTPS) dan memberikan izin.");
            }
        }

        /**
         * 2. Loop Deteksi Utama
         */
        async function detectFrame() {
            if (video.readyState < 2 || !model) {
                requestAnimationFrame(detectFrame);
                return;
            }
            
            // **KRUSIAL UNTUK ANALISIS WARNA:**
            // Gambar frame video ke canvas agar data piksel dapat diambil (getImageData)
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Jalankan deteksi
            const predictions = await model.detect(video);
            
            // Gambar kotak pembatas dan analisis warna
            drawBoundingBoxes(predictions);

            // Ulangi proses pada frame berikutnya
            requestAnimationFrame(detectFrame);
        }

        /**
         * 3. Menggambar Hasil Deteksi (Kotak, Label, dan Warna)
         */
        function drawBoundingBoxes(predictions) {
            // Bersihkan canvas dari kotak pembatas frame sebelumnya
            // Catatan: gambar video tetap ada karena sudah digambar di detectFrame()
            
            ctx.font = '16px Arial';
            ctx.lineWidth = 2;
            
            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;
                
                // Analisis warna rata-rata pada area objek
                const avgColor = getAverageColor(x, y, width, height);

                const confidence = Math.round(prediction.score * 100);
                const text = `${prediction.class} (${avgColor}, ${confidence}%)`;
                
                // Pengaturan Gaya
                const strokeColor = avgColor === "Merah" ? "#FF4136" : 
                                    avgColor === "Biru" ? "#0074D9" : 
                                    avgColor === "Hijau" ? "#2ECC40" : 
                                    "#FFDC00"; // Kuning default
                
                ctx.strokeStyle = strokeColor;
                ctx.strokeRect(x, y, width, height);
                
                // Gambar latar belakang teks
                ctx.fillStyle = strokeColor;
                const textWidth = ctx.measureText(text).width;
                ctx.fillRect(x, y, textWidth + 8, 20); 
                
                // Gambar teks
                ctx.fillStyle = '#000000'; // Warna Teks Hitam
                ctx.fillText(text, x + 4, y + 15);
            });
        }

        /**
         * 4. Fungsi Utama untuk Memulai Aplikasi
         */
        async function startApp() {
            try {
                statusElement.textContent = '1. Memuat model COCO-SSD...';
                // Muat model COCO-SSD
                model = await cocoSsd.load();
                statusElement.textContent = '2. Model berhasil dimuat. Meminta akses kamera...';

                // Akses dan setel video
                await setupWebcam();
                
                // Atur ukuran canvas dan video agar sinkron
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.width = video.videoWidth;
                video.height = video.videoHeight;
                // Tetapkan ukuran container agar sesuai
                document.getElementById('container').style.width = `${video.videoWidth}px`;
                document.getElementById('container').style.height = `${video.videoHeight}px`;


                statusElement.textContent = '3. Deteksi dan Analisis Warna dimulai...';
                
                // Mulai loop deteksi
                detectFrame();
                
            } catch (error) {
                // Tangani kesalahan, terutama kegagalan kamera/keamanan
                statusElement.textContent = `‚ùå ERROR: ${error.message}. SILAKAN CEK KONTAK ATAU JALANKAN DI SERVER LOKAL.`;
                console.error(error);
            }
        }

        startApp();
    </script>

</body>
</html>
